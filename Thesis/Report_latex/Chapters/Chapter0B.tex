%********************************************************************
% Appendix
%*******************************************************
% If problems with the headers: get headings in appendix etc. right
%\markboth{\spacedlowsmallcaps{Appendix}}{\spacedlowsmallcaps{Appendix}}
\chapter{Installing the application}\label{ch:appendix-b}

While \autoref{ch:appendix-a} focused on installing GF-related dependencies, this appendix explains how the application can be installed into an application server. Note that the application will not run unless all GF-dependencies are installed. The application (and the source code) can be downloaded from \url{http://thesis.agfjord.se/} where also a working demo of the application can be found.

\section{Installing and configurating Apache Tomcat}
This application can be executed by using any application server that supports \texttt{WAR}-files. The \texttt{WAR}-file in this project is built using Maven, which can also upload the file to an instance of the application server Tomcat. This method is very convenient since it automates a lot work. The following section describes how to install and configure Tomcat and Maven to work with this project.

Download and install Tomcat 8 and Maven (here by using aptitude package-manager).

\begin{terminal}
$ sudo apt-get install tomcat8 tomcat8-admin maven
\end{terminal}
%$

Tomcat requires an uploader to have the correct permissions.
\newline
Edit \texttt{/etc/tomcat8/tomcat-users.xml} and add the following:

\begin{terminal}
/etc/tomcat8/tomcat-users.xml
------------------------------------------------
<tomcat-users>
  <role rolename="manager-gui"/>
  <role rolename="manager-script"/>
  <user username="admin" password="secr3t" roles="manager-gui,manager-script"/>
</tomcat-users>
\end{terminal}

As the application will use the generated wrapper library \texttt{libjpgf.so}, we need to make a proper reference to this library and its dependencies (the C-libraries). This is achieved by creating a new file \texttt{setenv.sh} in the directory \texttt{/usr/share/tomcat8/bin/}, the location of this directory can differ on different Linux-distributions. The directory shall contain the file \texttt{catalina.sh}, so a search on the file should show the correct directory.

Create the file \texttt{setenv.sh} and add the following 

\begin{terminal}
/usr/share/tomcat8/bin/setenv.sh
------------------------------------------------
#!/bin/sh
export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
export JAVA_OPTS='-Dsolr.solr.home=<project_workspace>/solr-instrucs'
\end{terminal}
%$

Note that \texttt{<project\_workspace>} must be replaced by the actual location of the workspace, and make sure it is writeable by Tomcat. Restart Tomcat for the changes to take effect.

\begin{terminal}
$ sudo service tomcat8 restart
\end{terminal}
%$

The next thing we would like to do is to allow Maven to upload applications to Tomcat. As Tomcat now has an admin user with a password, we can use this to setup a server definition in Maven. 
\newline
Add the following to \texttt{/etc/maven/settings.xml}

\begin{terminal}
/etc/maven/settings.xml
------------------------------------------------
<servers>
 <server>
    <id>localTomcatServer</id>
    <username>admin</username>
    <password>secr3t</password>
  </server>
</servers>
\end{terminal}

The field \texttt{id} is used by the application to define that it shall be uploaded to the server we just specified.

\section{Uploading the Solr-service}
The application makes use of a Solr-service which is bundled as a maven project inside \texttt{<project\_workspace>/solr\_mvn}. The Solr-service can be uploaded to Tomcat by executing the following:

\begin{terminal}
$ cd <project_directory>/solr_mvn/
$ mvn tomcat7:deploy
\end{terminal}
%$

\section{Generating mock-data}
We generate mock-data for the suggestion engine by executing a program. The program uses a the jar file \texttt{org.grammaticalframework.pgf.jar} as dependency, the jar must therefore be added to the local maven repository. Execute the following:

\begin{terminal}
$ cd <project_directory>/
$ mvn install:install-file -Dfile=org.grammaticalframework.pgf.jar 
                           -DgroupId=org.grammaticalframework 
                           -DartifactId=pgf -Dversion=1.0 -Dpackaging=jar
\end{terminal}

Mock data can now be generated by executing the following:


\begin{terminal}
$ cd <project_directory>/mock-data/
$ mvn compile
$ export MAVEN_OPTS='-Djava.library.path=/usr/local/lib'
$ mvn exec:java -Dexec.mainClass="org.agfjord.graph.Main"
\end{terminal}
%$

There also exists a script \texttt{populize\_solr} inside \texttt{mock-data/} that is more convenient to use.

\section{Uploading the website}

The project can be uploaded to tomcat by executing the following:

\begin{terminal}
$ cd <project_directory>/nlparser/
$ mvn tomcat7:deploy
\end{terminal}
%$

The application shall now be accessible through the URL
\newline
 \url{http://localhost:8080/nlparser}.
